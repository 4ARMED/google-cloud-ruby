---
layout: yard_main
title: "Class: Google::Cloud::Debugger::Middleware - Stackdriver"
css: 
  - /docs/css/style.css
  - /docs/css/common.css
  - /css/yard-main.css
js: 
  - /docs/js/app.js
  - /js/yard-main.js
---
<script type="text/javascript" charset="utf-8">
  pathId = "Google::Cloud::Debugger::Middleware";
  relpath = '../../../';
</script>


<div class="nav_wrap">
  <iframe id="nav" src="../../../class_list.html?1"></iframe>
  <div id="resizer"></div>
</div>

<div id="main" tabindex="-1">
  <div id="header">
    <div id="menu">
  
    <a href="../../../_index.html">Index (M)</a> &raquo;
    <span class='title'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../../Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span> &raquo; <span class='title'><span class='object_link'><a href="../Debugger.html" title="Google::Cloud::Debugger (module)">Debugger</a></span></span>
     &raquo; 
    <span class="title">Middleware</span>
  
</div>

    <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="../../../class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
    <div class="clear"></div>
  </div>

  <div id="content"><h1>Class: Google::Cloud::Debugger::Middleware
  
  
  
</h1>
<div class="box_info">
  
  <dl>
    <dt>Inherits:</dt>
    <dd>
      <span class="inheritName">Object</span>
      
        <ul class="fullTree">
          <li>Object</li>
          
            <li class="next">Google::Cloud::Debugger::Middleware</li>
          
        </ul>
        <a href="#" class="inheritanceTree">show all</a>
      
    </dd>
  </dl>
  

  
  
  
  
  

  

  
  <dl>
    <dt>Defined in:</dt>
    <dd>lib/google/cloud/debugger/middleware.rb</dd>
  </dl>
  
</div>

<h2>Overview</h2><div class="docstring">
  <div class="discussion">
    <p>Rack Middleware implementation that supports Stackdriver Debugger Agent
in Rack-based Ruby frameworks. It instantiates a new debugger agent if
one isn&#39;t given already. It helps optimize Debugger Agent Tracer
performance by suspending and resuming the tracer between each request.</p>

<p>To use this middleware, simply install it in your Rack configuration.
The middleware will take care of registering itself with the
Stackdriver Debugger and activating the debugger agent. The location
of the middleware in the middleware stack matters: breakpoints will be
detected in middleware appearing after but not before this middleware.</p>

<p>For best results, you should also call <span class='object_link'><a href="#start_agents-class_method" title="Google::Cloud::Debugger::Middleware.start_agents (method)">Middleware.start_agents</a></span>
during application initialization. See its documentation for details.</p>


  </div>
</div>
<div class="tags">
  

</div>






  
    <h2>
      Class Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#start_agents-class_method" title="start_agents (class method)">.<strong>start_agents</strong>  &#x21d2; Object </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>This should be called once the application determines that it is safe to start background threads and open gRPC connections.</p>
</div></span>
  
</li>

      
    </ul>
  
    <h2>
      Instance Method Summary
      <small><a href="#" class="summary_toggle">collapse</a></small>
    </h2>

    <ul class="summary">
      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#call-instance_method" title="#call (instance method)">#<strong>call</strong>(env)  &#x21d2; Rack::Response </a>
    

    
  </span>
  
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Rack middleware entry point.</p>
</div></span>
  
</li>

      
        <li class="public ">
  <span class="summary_signature">
    
      <a href="#initialize-instance_method" title="#initialize (instance method)">#<strong>initialize</strong>(app, debugger: nil, **kwargs)  &#x21d2; Google::Cloud::Debugger::Middleware </a>
    

    
  </span>
  
  
    <span class="note title constructor">constructor</span>
  
  
  
  
  
  

  
    <span class="summary_desc"><div class='inline'><p>Create a new Debugger Middleware.</p>
</div></span>
  
</li>

      
    </ul>
  

<div id="constructor_details" class="method_details_list">
  <h2>Constructor Details</h2>
  
    <div class="method_details first">
  <h3 class="signature first" id="initialize-instance_method">
  
    #<strong>initialize</strong>(app, debugger: nil, **kwargs)  &#x21d2; <tt><span class='object_link'><a href="" title="Google::Cloud::Debugger::Middleware (class)">Google::Cloud::Debugger::Middleware</a></span></tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Create a new Debugger Middleware.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>app</span>
      
      
        <span class='type'>(<tt>Rack Application</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Rack application</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>debugger</span>
      
      
        <span class='type'>(<tt><span class='object_link'><a href="Project.html" title="Google::Cloud::Debugger::Project (class)">Google::Cloud::Debugger::Project</a></span></tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>A debugger to be
used by this middleware. If not given, will construct a new one
using the other parameters.</p>
</div>
      
    </li>
  
    <li>
      
        <span class='name'>kwargs</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Hash of configuration settings. Used for backward
API compatibility. See the <a href="https://googleapis.github.io/google-cloud-ruby/docs/stackdriver/latest/file.INSTRUMENTATION_CONFIGURATION">Configuration
Guide</a>
for the prefered way to set configuration parameters.</p>
</div>
      
    </li>
  
</ul>


</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/debugger/middleware.rb', line 108</span>

<span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span> <span class='id identifier rubyid_app'>app</span><span class='comma'>,</span> <span class='label'>debugger:</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='op'>**</span><span class='id identifier rubyid_kwargs'>kwargs</span>
  <span class='ivar'>@app</span> <span class='op'>=</span> <span class='id identifier rubyid_app'>app</span>

  <span class='id identifier rubyid_load_config'>load_config</span> <span class='id identifier rubyid_kwargs'>kwargs</span>

  <span class='kw'>if</span> <span class='id identifier rubyid_debugger'>debugger</span>
    <span class='ivar'>@debugger</span> <span class='op'>=</span> <span class='id identifier rubyid_debugger'>debugger</span>
  <span class='kw'>else</span>
    <span class='ivar'>@debugger</span> <span class='op'>=</span>
      <span class='const'><span class='object_link'><a href="../Debugger.html" title="Google::Cloud::Debugger (module)">Debugger</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Debugger.html#new-class_method" title="Google::Cloud::Debugger.new (method)">new</a></span></span><span class='lparen'>(</span><span class='label'>project_id:</span> <span class='id identifier rubyid_configuration'>configuration</span><span class='period'>.</span><span class='id identifier rubyid_project_id'>project_id</span><span class='comma'>,</span>
                   <span class='label'>credentials:</span> <span class='id identifier rubyid_configuration'>configuration</span><span class='period'>.</span><span class='id identifier rubyid_credentials'>credentials</span><span class='comma'>,</span>
                   <span class='label'>service_name:</span> <span class='id identifier rubyid_configuration'>configuration</span><span class='period'>.</span><span class='id identifier rubyid_service_name'>service_name</span><span class='comma'>,</span>
                   <span class='label'>service_version:</span> <span class='id identifier rubyid_configuration'>configuration</span><span class='period'>.</span><span class='id identifier rubyid_service_version'>service_version</span><span class='rparen'>)</span>

    <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_quota_manager'>quota_manager</span> <span class='op'>=</span>
      <span class='const'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../Debugger.html" title="Google::Cloud::Debugger (module)">Debugger</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="RequestQuotaManager.html" title="Google::Cloud::Debugger::RequestQuotaManager (class)">RequestQuotaManager</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="../Debugger.html#new-class_method" title="Google::Cloud::Debugger.new (method)">new</a></span></span>
  <span class='kw'>end</span>

  <span class='const'><span class='object_link'><a href="" title="Google::Cloud::Debugger::Middleware (class)">Middleware</a></span></span><span class='period'>.</span><span class='id identifier rubyid_deferred_start'>deferred_start</span> <span class='ivar'>@debugger</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
  
</div>


  <div id="class_method_details" class="method_details_list">
    <h2>Class Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="start_agents-class_method">
  
    .<strong>start_agents</strong>  &#x21d2; <tt>Object</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>This should be called once the application determines that it is safe
to start background threads and open gRPC connections. It informs
the middleware system that it can start debugger agents.</p>

<p>Generally, this matters if the application forks worker processes;
this method should be called only after workers are forked, since
threads and network connections interact badly with fork. For
example, when running Puma in
<a href="https://github.com/puma/puma#clustered-mode">clustered mode</a>, this
method should be called in an <code>on_worker_boot</code> block.</p>

<p>If the application does no forking, this method can be called any
time early in the application initialization process.</p>

<p>If <span class='object_link'><a href="#start_agents-class_method" title="Google::Cloud::Debugger::Middleware.start_agents (method)">start_agents</a></span> is never called, the debugger agent will
be started when the first request is received. This should be safe,
but it will probably mean breakpoints will not be recognized during
that first request. For best results, an application should call this
method at the appropriate time.</p>


  </div>
</div>
<div class="tags">
  

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


87
88
89
90
91</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/debugger/middleware.rb', line 87</span>

<span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_start_agents'>start_agents</span>
  <span class='kw'>return</span> <span class='kw'>unless</span> <span class='ivar'>@debuggers_to_start</span>
  <span class='ivar'>@debuggers_to_start</span><span class='period'>.</span><span class='id identifier rubyid_each'>each</span><span class='lparen'>(</span><span class='op'>&amp;</span><span class='symbol'>:start</span><span class='rparen'>)</span>
  <span class='ivar'>@debuggers_to_start</span> <span class='op'>=</span> <span class='kw'>nil</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

  <div id="instance_method_details" class="method_details_list">
    <h2>Instance Method Details</h2>

    
      <div class="method_details first">
  <h3 class="signature first" id="call-instance_method">
  
    #<strong>call</strong>(env)  &#x21d2; <tt>Rack::Response</tt> 
  

  

  
</h3><div class="docstring">
  <div class="discussion">
    <p>Rack middleware entry point. In most Rack based frameworks, a request
is served by one thread. It enables/resume the debugger breakpoints
tracing and stops/pauses the tracing afterwards to help improve
debugger performance.</p>


  </div>
</div>
<div class="tags">
  <p class="tag_title">Parameters:</p>
<ul class="param">
  
    <li>
      
        <span class='name'>env</span>
      
      
        <span class='type'>(<tt>Hash</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>Rack environment hash</p>
</div>
      
    </li>
  
</ul>

<p class="tag_title">Returns:</p>
<ul class="return">
  
    <li>
      
      
        <span class='type'>(<tt>Rack::Response</tt>)</span>
      
      
      
        &mdash;
        <div class='inline'><p>The response from downstream Rack app</p>
</div>
      
    </li>
  
</ul>

</div><table class="source_code">
  <tr>
    <td>
      <pre class="lines">


139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158</pre>
    </td>
    <td>
      <pre class="code"><span class="info file"># File 'lib/google/cloud/debugger/middleware.rb', line 139</span>

<span class='kw'>def</span> <span class='id identifier rubyid_call'>call</span> <span class='id identifier rubyid_env'>env</span>
  <span class='comment'># Ensure the agent is running. (Note the start method is idempotent.)
</span>  <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

  <span class='comment'># Enable/resume breakpoints tracing
</span>  <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_tracer'>tracer</span><span class='period'>.</span><span class='id identifier rubyid_start'>start</span>

  <span class='comment'># Use Stackdriver Logger for debugger if available
</span>  <span class='kw'>if</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rack.logger</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span><span class='period'>.</span><span class='id identifier rubyid_is_a?'>is_a?</span> <span class='const'><span class='object_link'><a href="../../../Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="../../Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'>Logging</span><span class='op'>::</span><span class='const'>Logger</span>
    <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_logger'>logger</span> <span class='op'>=</span> <span class='id identifier rubyid_env'>env</span><span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>rack.logger</span><span class='tstring_end'>&quot;</span></span><span class='rbracket'>]</span>
  <span class='kw'>end</span>

  <span class='ivar'>@app</span><span class='period'>.</span><span class='id identifier rubyid_call'>call</span> <span class='id identifier rubyid_env'>env</span>
<span class='kw'>ensure</span>
  <span class='comment'># Stop breakpoints tracing beyond this point
</span>  <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_tracer'>tracer</span><span class='period'>.</span><span class='id identifier rubyid_disable_traces_for_thread'>disable_traces_for_thread</span>

  <span class='comment'># Reset quotas after each request finishes.
</span>  <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_quota_manager'>quota_manager</span><span class='period'>.</span><span class='id identifier rubyid_reset'>reset</span> <span class='kw'>if</span> <span class='ivar'>@debugger</span><span class='period'>.</span><span class='id identifier rubyid_agent'>agent</span><span class='period'>.</span><span class='id identifier rubyid_quota_manager'>quota_manager</span>
<span class='kw'>end</span></pre>
    </td>
  </tr>
</table>
</div>
    
  </div>

</div>

  <div id="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby" title="Google Cloud on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> GitHub
      </a>
    </li>
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/issues" title="Google Cloud issues on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> Issues
      </a>
    </li>
    <li>
      <a href="http://stackoverflow.com/questions/tagged/google-cloud-ruby" title="Google Cloud on StackOverflow">
      <img src="/google-cloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon"> StackOverflow
    </a>
    </li>
    <li>
      <a href="http://rubygems.org/gems/google-cloud" title="Google Cloud on RubyGems">
        <img src="/google-cloud-ruby/img/icon-link-package-manager.svg" alt="RubyGems icon"> RubyGems
      </a>
    </li>
  </ul>

  <p>
    Documentation generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>.
  </p>
</div>

</div>
