---
layout: yard_main
title: "File: OVERVIEW - Google"
css: 
  - /docs/css/style.css
  - /docs/css/common.css
  - /css/yard-main.css
js: 
  - /docs/js/app.js
  - /js/yard-main.js
---
<script type="text/javascript" charset="utf-8">
  pathId = "OVERVIEW";
  relpath = '';
</script>


<div class="nav_wrap">
  <iframe id="nav" src="file_list.html?1"></iframe>
  <div id="resizer"></div>
</div>

<div id="main" tabindex="-1">
  <div id="header">
    <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: OVERVIEW</span>
  
</div>

    <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
    <div class="clear"></div>
  </div>

  <div id="content"><div id='filecontents'><h1>Google Cloud BigQuery</h1>

<p>Google BigQuery enables super-fast, SQL-like queries against massive datasets,
using the processing power of Google&#39;s infrastructure. To learn more, read <a href="https://cloud.google.com/bigquery/what-is-bigquery">What
is BigQuery?</a>.</p>

<p>The goal of google-cloud is to provide an API that is comfortable to Rubyists.
Your authentication credentials are detected automatically in Google Cloud
Platform environments such as Google Compute Engine, Google App Engine and
Google Kubernetes Engine. In other environments you can configure authentication
easily, either directly in your code or via environment variables. Read more
about the options for connecting in the <a href="file.AUTHENTICATION.html" title="Authentication Guide">Authentication Guide</a>.</p>

<p>To help you get started quickly, the first few examples below use a public
dataset provided by Google. As soon as you have <a href="https://cloud.google.com/bigquery/sign-up">signed
up</a> to use BigQuery, and provided
that you stay in the free tier for queries, you should be able to run these
first examples without the need to set up billing or to load data (although
we&#39;ll show you how to do that too.)</p>

<h2>Listing Datasets and Tables</h2>

<p>A BigQuery project contains datasets, which in turn contain tables. Assuming
that you have not yet created datasets or tables in your own project, let&#39;s
connect to Google&#39;s <code>bigquery-public-data</code> project, and see what we find.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span> <span class='label'>project:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bigquery-public-data</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_datasets'>datasets</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='comment'>#=&gt; 1
</span><span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_datasets'>datasets</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_dataset_id'>dataset_id</span> <span class='comment'>#=&gt; &quot;samples&quot;
</span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_datasets'>datasets</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
<span class='id identifier rubyid_tables'>tables</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_tables'>tables</span>

<span class='id identifier rubyid_tables'>tables</span><span class='period'>.</span><span class='id identifier rubyid_count'>count</span> <span class='comment'>#=&gt; 7
</span><span class='id identifier rubyid_tables'>tables</span><span class='period'>.</span><span class='id identifier rubyid_map'>map</span> <span class='op'>&amp;</span><span class='symbol'>:table_id</span> <span class='comment'>#=&gt; [..., &quot;shakespeare&quot;, &quot;trigrams&quot;, &quot;wikipedia&quot;]
</span></code></pre>

<p>In addition to listing all datasets and tables in the project, you can also
retrieve individual datasets and tables by ID. Let&#39;s look at the structure of
the <code>shakespeare</code> table, which contains an entry for every word in every play
written by Shakespeare.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span> <span class='label'>project:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bigquery-public-data</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>samples</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_table'>table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>shakespeare</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_headers'>headers</span> <span class='comment'>#=&gt; [:word, :word_count, :corpus, :corpus_date]
</span><span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_rows_count'>rows_count</span> <span class='comment'>#=&gt; 164656
</span></code></pre>

<p>Now that you know the column names for the Shakespeare table, let&#39;s write and
run a few queries against it.</p>

<h2>Running queries</h2>

<p>BigQuery supports two SQL dialects: <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/">standard
SQL</a> and the
older <a href="https://cloud.google.com/bigquery/docs/reference/legacy-sql">legacy SQl (BigQuery
SQL)</a>, as discussed
in the guide <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/migrating-from-legacy-sql">Migrating from legacy
SQL</a>.</p>

<h3>Standard SQL</h3>

<p>Standard SQL is the preferred SQL dialect for querying data stored in BigQuery.
It is compliant with the SQL 2011 standard, and has extensions that support
querying nested and repeated data. This is the default syntax. It has several
advantages over legacy SQL, including:</p>

<ul>
<li>Composability using <code>WITH</code> clauses and SQL functions</li>
<li>Subqueries in the <code>SELECT</code> list and <code>WHERE</code> clause</li>
<li>Correlated subqueries</li>
<li><code>ARRAY</code> and <code>STRUCT</code> data types</li>
<li>Inserts, updates, and deletes</li>
<li><code>COUNT(DISTINCT &lt;expr&gt;)</code> is exact and scalable, providing the accuracy of
<code>EXACT_COUNT_DISTINCT</code> without its limitations</li>
<li>Automatic predicate push-down through <code>JOIN</code>s</li>
<li>Complex <code>JOIN</code> predicates, including arbitrary expressions</li>
</ul>

<p>For examples that demonstrate some of these features, see <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/migrating-from-legacy-l#standard_sql_highlights">Standard SQL
ghlights</a>.</p>

<p>As shown in this example, standard SQL is the library default:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT word, SUM(word_count) AS word_count </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM `bigquery-public-data.samples.shakespeare`</span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WHERE word IN (&#39;me&#39;, &#39;I&#39;, &#39;you&#39;) GROUP BY word</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='id identifier rubyid_sql'>sql</span>
</code></pre>

<p>Notice that in standard SQL, a fully-qualified table name uses the following
format: <code><code>my-dashed-project.dataset1.tableName</code></code>.</p>

<h3>Legacy SQL (formerly BigQuery SQL)</h3>

<p>Before version 2.0, BigQuery executed queries using a non-standard SQL dialect
known as BigQuery SQL. This variant is optional, and can be enabled by passing
the flag <code>legacy_sql: true</code> with your query. (If you get an SQL syntax error
with a query that may be written in legacy SQL, be sure that you are passing
this option.)</p>

<p>To use legacy SQL, pass the option <code>legacy_sql: true</code> with your query:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT TOP(word, 50) as word, COUNT(*) as count </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM [bigquery-public-data:samples.shakespeare]</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='label'>legacy_sql:</span> <span class='kw'>true</span>
</code></pre>

<p>Notice that in legacy SQL, a fully-qualified table name uses brackets instead of
back-ticks, and a colon instead of a dot to separate the project and the
dataset: <code>[my-dashed-project:dataset1.tableName]</code>.</p>

<h4>Query parameters</h4>

<p>With standard SQL, you can use positional or named query parameters. This
example shows the use of named parameters:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT word, SUM(word_count) AS word_count </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM `bigquery-public-data.samples.shakespeare`</span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WHERE word IN UNNEST(@words) GROUP BY word</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='label'>params:</span> <span class='lbrace'>{</span> <span class='label'>words:</span> <span class='lbracket'>[</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>me</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>I</span><span class='tstring_end'>&#39;</span></span><span class='comma'>,</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>you</span><span class='tstring_end'>&#39;</span></span><span class='rbracket'>]</span> <span class='rbrace'>}</span>
</code></pre>

<p>As demonstrated above, passing the <code>params</code> option will automatically set
<code>standard_sql</code> to <code>true</code>.</p>

<h4>Data types</h4>

<p>BigQuery standard SQL supports simple data types such as integers, as well as
more complex types such as <code>ARRAY</code> and <code>STRUCT</code>.</p>

<p>The BigQuery data types are converted to and from Ruby types as follows:</p>

<table><thead>
<tr>
<th>BigQuery</th>
<th>Ruby</th>
<th>Notes</th>
</tr>
</thead><tbody>
<tr>
<td><code>BOOL</code></td>
<td><code>true</code>/<code>false</code></td>
<td></td>
</tr>
<tr>
<td><code>INT64</code></td>
<td><code>Integer</code></td>
<td></td>
</tr>
<tr>
<td><code>FLOAT64</code></td>
<td><code>Float</code></td>
<td></td>
</tr>
<tr>
<td><code>NUMERIC</code></td>
<td><code>BigDecimal</code></td>
<td>Will be rounded to 9 decimal places</td>
</tr>
<tr>
<td><code>STRING</code></td>
<td><code>String</code></td>
<td></td>
</tr>
<tr>
<td><code>DATETIME</code></td>
<td><code>DateTime</code></td>
<td><code>DATETIME</code> does not support time zone.</td>
</tr>
<tr>
<td><code>DATE</code></td>
<td><code>Date</code></td>
<td></td>
</tr>
<tr>
<td><code>TIMESTAMP</code></td>
<td><code>Time</code></td>
<td></td>
</tr>
<tr>
<td><code>TIME</code></td>
<td><code>Google::Cloud::BigQuery::Time</code></td>
<td></td>
</tr>
<tr>
<td><code>BYTES</code></td>
<td><code>File</code>, <code>IO</code>, <code>StringIO</code>, or similar</td>
<td></td>
</tr>
<tr>
<td><code>ARRAY</code></td>
<td><code>Array</code></td>
<td>Nested arrays and <code>nil</code> values are not supported.</td>
</tr>
<tr>
<td><code>STRUCT</code></td>
<td><code>Hash</code></td>
<td>Hash keys may be strings or symbols.</td>
</tr>
</tbody></table>

<p>See <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/data-types">Data
Types</a>
for an overview of each BigQuery data type, including allowed values.</p>

<h3>Running Queries</h3>

<p>Let&#39;s start with the simplest way to run a query. Notice that this time you are
connecting using your own default project. It is necessary to have write access
to the project for running a query, since queries need to create tables to hold
results.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT APPROX_TOP_COUNT(corpus, 10) as title, </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>COUNT(*) as unique_words </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM `bigquery-public-data.samples.shakespeare`</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_data'>data</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_query'>query</span> <span class='id identifier rubyid_sql'>sql</span>

<span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_next?'>next?</span> <span class='comment'>#=&gt; false
</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span> <span class='comment'>#=&gt; {:title=&gt;[{:value=&gt;&quot;hamlet&quot;, :count=&gt;5318}, ...}
</span></code></pre>

<p>The <code>APPROX_TOP_COUNT</code> function shown above is just one of a variety of
functions offered by BigQuery. See the <a href="https://cloud.google.com/bigquery/docs/reference/standard-sql/functions-and-operators">Query Reference (standard
SQL)</a>
for a full listing.</p>

<h3>Query Jobs</h3>

<p>It is usually best not to block for most BigQuery operations, including querying
as well as importing, exporting, and copying data. Therefore, the BigQuery API
provides facilities for managing longer-running jobs. With this approach, an
instance of <span class='object_link'><a href="Google/Cloud/Bigquery/QueryJob.html" title="Google::Cloud::Bigquery::QueryJob (class)">Google::Cloud::Bigquery::QueryJob</a></span> is returned, rather than an
instance of <span class='object_link'><a href="Google/Cloud/Bigquery/Data.html" title="Google::Cloud::Bigquery::Data (class)">Google::Cloud::Bigquery::Data</a></span>.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT APPROX_TOP_COUNT(corpus, 10) as title, </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>COUNT(*) as unique_words </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM `bigquery-public-data.samples.shakespeare`</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_job'>job</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_query_job'>query_job</span> <span class='id identifier rubyid_sql'>sql</span>

<span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_wait_until_done!'>wait_until_done!</span>
<span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_failed?'>failed?</span>
  <span class='id identifier rubyid_job'>job</span><span class='period'>.</span><span class='id identifier rubyid_data'>data</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span>
  <span class='comment'>#=&gt; {:title=&gt;[{:value=&gt;&quot;hamlet&quot;, :count=&gt;5318}, ...}
</span><span class='kw'>end</span>
</code></pre>

<p>Once you have determined that the job is done and has not failed, you can obtain
an instance of <span class='object_link'><a href="Google/Cloud/Bigquery/Data.html" title="Google::Cloud::Bigquery::Data (class)">Google::Cloud::Bigquery::Data</a></span> by calling <code>data</code> on the job
instance. The query results for both of the above examples are stored in
temporary tables with a lifetime of about 24 hours. See the final example below
for a demonstration of how to store query results in a permanent table.</p>

<h2>Creating Datasets and Tables</h2>

<p>The first thing you need to do in a new BigQuery project is to create a
<span class='object_link'><a href="Google/Cloud/Bigquery/Dataset.html" title="Google::Cloud::Bigquery::Dataset (class)">Google::Cloud::Bigquery::Dataset</a></span>. Datasets hold tables and control access to
them.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>

<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_create_dataset'>create_dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Now that you have a dataset, you can use it to create a table. Every table is
defined by a schema that may contain nested and repeated fields. The example
below shows a schema with a repeated record field named <code>cities_lived</code>. (For
more information about nested and repeated fields, see <a href="https://cloud.google.com/bigquery/preparing-data-for-loading">Preparing Data for
Loading</a>.)</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>people</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_schema'>schema</span><span class='op'>|</span>
  <span class='id identifier rubyid_schema'>schema</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
  <span class='id identifier rubyid_schema'>schema</span><span class='period'>.</span><span class='id identifier rubyid_record'>record</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cities_lived</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:repeated</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_nested_schema'>nested_schema</span><span class='op'>|</span>
    <span class='id identifier rubyid_nested_schema'>nested_schema</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
    <span class='id identifier rubyid_nested_schema'>nested_schema</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<p>Because of the repeated field in this schema, we cannot use the CSV format to
load data into the table.</p>

<h2>Loading records</h2>

<p>To follow along with these examples, you will need to set up billing on the
<a href="https://console.developers.google.com">Google Developers Console</a>.</p>

<p>In addition to CSV, data can be imported from files that are formatted as
<a href="http://jsonlines.org/">Newline-delimited JSON</a>,
<a href="http://avro.apache.org/">Avro</a>,
<a href="https://cloud.google.com/bigquery/docs/loading-data-cloud-storage-orc">ORC</a>,
<a href="https://parquet.apache.org/">Parquet</a> or from a Google Cloud Datastore backup.
It can also be &quot;streamed&quot; into BigQuery.</p>

<h3>Streaming records</h3>

<p>For situations in which you want new data to be available for querying as soon
as possible, inserting individual records directly from your Ruby application is
a great approach.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_table'>table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>people</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='lbracket'>[</span>
    <span class='lbrace'>{</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Anna</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cities_lived</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stockholm</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>2</span>
            <span class='rbrace'>}</span>
        <span class='rbracket'>]</span>
    <span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='lbrace'>{</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cities_lived</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Seattle</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>5</span>
            <span class='rbrace'>}</span><span class='comma'>,</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Austin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>6</span>
            <span class='rbrace'>}</span>
        <span class='rbracket'>]</span>
    <span class='rbrace'>}</span>
<span class='rbracket'>]</span>
<span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span> <span class='id identifier rubyid_rows'>rows</span>
</code></pre>

<p>To avoid making RPCs (network requests) to retrieve the dataset and table
resources when streaming records, pass the <code>skip_lookup</code> option. This creates
local objects without verifying that the resources exist on the BigQuery
service.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>skip_lookup:</span> <span class='kw'>true</span>
<span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_table'>table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>people</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>skip_lookup:</span> <span class='kw'>true</span>

<span class='id identifier rubyid_rows'>rows</span> <span class='op'>=</span> <span class='lbracket'>[</span>
    <span class='lbrace'>{</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Anna</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cities_lived</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Stockholm</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>2</span>
            <span class='rbrace'>}</span>
        <span class='rbracket'>]</span>
    <span class='rbrace'>}</span><span class='comma'>,</span>
    <span class='lbrace'>{</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>first_name</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Bob</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
        <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>cities_lived</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='lbracket'>[</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Seattle</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>5</span>
            <span class='rbrace'>}</span><span class='comma'>,</span>
            <span class='lbrace'>{</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>place</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>Austin</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span>
                <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>number_of_years</span><span class='tstring_end'>&quot;</span></span> <span class='op'>=&gt;</span> <span class='int'>6</span>
            <span class='rbrace'>}</span>
        <span class='rbracket'>]</span>
    <span class='rbrace'>}</span>
<span class='rbracket'>]</span>
<span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_insert'>insert</span> <span class='id identifier rubyid_rows'>rows</span>
</code></pre>

<p>There are some trade-offs involved with streaming, so be sure to read the
discussion of data consistency in <a href="https://cloud.google.com/bigquery/streaming-data-into-bigquery">Streaming Data Into
BigQuery</a>.</p>

<h3>Uploading a file</h3>

<p>To follow along with this example, please download the
<a href="http://www.ssa.gov/OACT/babynames/names.zip">names.zip</a> archive from the U.S.
Social Security Administration. Inside the archive you will find over 100 files
containing baby name records since the year 1880.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_table'>table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>baby_names</span><span class='tstring_end'>&quot;</span></span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid_schema'>schema</span><span class='op'>|</span>
  <span class='id identifier rubyid_schema'>schema</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>name</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
  <span class='id identifier rubyid_schema'>schema</span><span class='period'>.</span><span class='id identifier rubyid_string'>string</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gender</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
  <span class='id identifier rubyid_schema'>schema</span><span class='period'>.</span><span class='id identifier rubyid_integer'>integer</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>count</span><span class='tstring_end'>&quot;</span></span><span class='comma'>,</span> <span class='label'>mode:</span> <span class='symbol'>:required</span>
<span class='kw'>end</span>

<span class='id identifier rubyid_file'>file</span> <span class='op'>=</span> <span class='const'>File</span><span class='period'>.</span><span class='id identifier rubyid_open'>open</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>names/yob2014.txt</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_table'>table</span><span class='period'>.</span><span class='id identifier rubyid_load'>load</span> <span class='id identifier rubyid_file'>file</span><span class='comma'>,</span> <span class='label'>format:</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>csv</span><span class='tstring_end'>&quot;</span></span>
</code></pre>

<p>Because the names data, although formatted as CSV, is distributed in files with
a <code>.txt</code> extension, this example explicitly passes the <code>format</code> option in order
to demonstrate how to handle such situations. Because CSV is the default format
for load operations, the option is not actually necessary. For JSON saved with a
<code>.txt</code> extension, however, it would be.</p>

<h2>Exporting query results to Google Cloud Storage</h2>

<p>The example below shows how to pass the <code>table</code> option with a query in order to
store results in a permanent table. It also shows how to export the result data
to a Google Cloud Storage file. In order to follow along, you will need to
enable the Google Cloud Storage API in addition to setting up billing.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span>
<span class='id identifier rubyid_dataset'>dataset</span> <span class='op'>=</span> <span class='id identifier rubyid_bigquery'>bigquery</span><span class='period'>.</span><span class='id identifier rubyid_dataset'>dataset</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>my_dataset</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_source_table'>source_table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_table'>table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>baby_names</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_result_table'>result_table</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_create_table'>create_table</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>baby_names_results</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_sql'>sql</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>SELECT name, count </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>FROM baby_names </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>WHERE gender = &#39;M&#39; </span><span class='tstring_end'>&quot;</span></span> \
      <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>ORDER BY count ASC LIMIT 5</span><span class='tstring_end'>&quot;</span></span>
<span class='id identifier rubyid_query_job'>query_job</span> <span class='op'>=</span> <span class='id identifier rubyid_dataset'>dataset</span><span class='period'>.</span><span class='id identifier rubyid_query_job'>query_job</span> <span class='id identifier rubyid_sql'>sql</span><span class='comma'>,</span> <span class='label'>table:</span> <span class='id identifier rubyid_result_table'>result_table</span>

<span class='id identifier rubyid_query_job'>query_job</span><span class='period'>.</span><span class='id identifier rubyid_wait_until_done!'>wait_until_done!</span>

<span class='kw'>if</span> <span class='op'>!</span><span class='id identifier rubyid_query_job'>query_job</span><span class='period'>.</span><span class='id identifier rubyid_failed?'>failed?</span>
  <span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/storage</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_storage'>storage</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'>Storage</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
  <span class='id identifier rubyid_bucket_id'>bucket_id</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>bigquery-exports-</span><span class='embexpr_beg'>#{</span><span class='const'>SecureRandom</span><span class='period'>.</span><span class='id identifier rubyid_uuid'>uuid</span><span class='embexpr_end'>}</span><span class='tstring_end'>&quot;</span></span>
  <span class='id identifier rubyid_bucket'>bucket</span> <span class='op'>=</span> <span class='id identifier rubyid_storage'>storage</span><span class='period'>.</span><span class='id identifier rubyid_create_bucket'>create_bucket</span> <span class='id identifier rubyid_bucket_id'>bucket_id</span>
  <span class='id identifier rubyid_extract_url'>extract_url</span> <span class='op'>=</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>gs://</span><span class='embexpr_beg'>#{</span><span class='id identifier rubyid_bucket'>bucket</span><span class='period'>.</span><span class='id identifier rubyid_id'>id</span><span class='embexpr_end'>}</span><span class='tstring_content'>/baby-names.csv</span><span class='tstring_end'>&quot;</span></span>

  <span class='id identifier rubyid_result_table'>result_table</span><span class='period'>.</span><span class='id identifier rubyid_extract'>extract</span> <span class='id identifier rubyid_extract_url'>extract_url</span>

  <span class='comment'># Download to local filesystem
</span>  <span class='id identifier rubyid_bucket'>bucket</span><span class='period'>.</span><span class='id identifier rubyid_files'>files</span><span class='period'>.</span><span class='id identifier rubyid_first'>first</span><span class='period'>.</span><span class='id identifier rubyid_download'>download</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>baby-names.csv</span><span class='tstring_end'>&quot;</span></span>
<span class='kw'>end</span>
</code></pre>

<p>If a table you wish to export contains a large amount of data, you can pass a
wildcard URI to export to multiple files (for sharding), or an array of URIs
(for partitioning), or both. See <a href="https://cloud.google.com/bigquery/docs/exporting-data">Exporting
Data</a> for details.</p>

<h2>Configuring retries and timeout</h2>

<p>You can configure how many times API requests may be automatically retried. When
an API request fails, the response will be inspected to see if the request meets
criteria indicating that it may succeed on retry, such as <code>500</code> and <code>503</code> status
codes or a specific internal error code such as <code>rateLimitExceeded</code>. If it meets
the criteria, the request will be retried after a delay. If another error
occurs, the delay will be increased before a subsequent attempt, until the
<code>retries</code> limit is reached.</p>

<p>You can also set the request <code>timeout</code> value in seconds.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>google/cloud/bigquery</span><span class='tstring_end'>&quot;</span></span>

<span class='id identifier rubyid_bigquery'>bigquery</span> <span class='op'>=</span> <span class='const'><span class='object_link'><a href="Google.html" title="Google (module)">Google</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud.html" title="Google::Cloud (module)">Cloud</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="Google/Cloud/Bigquery.html" title="Google::Cloud::Bigquery (module)">Bigquery</a></span></span><span class='period'>.</span><span class='id identifier rubyid_new'><span class='object_link'><a href="Google/Cloud/Bigquery.html#new-class_method" title="Google::Cloud::Bigquery.new (method)">new</a></span></span> <span class='label'>retries:</span> <span class='int'>10</span><span class='comma'>,</span> <span class='label'>timeout:</span> <span class='int'>120</span>
</code></pre>

<p>See the <a href="https://cloud.google.com/bigquery/troubleshooting-errors#errortable">BigQuery error
table</a> for
a list of error conditions.</p>

<h2>Additional information</h2>

<p>Google BigQuery can be configured to use logging. To learn more, see the
<a href="file.LOGGING.html" title="Logging guide">Logging guide</a>.</p>
</div></div>

  <div id="footer">
  <ul class="footer-links">
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby" title="Google Cloud on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> GitHub
      </a>
    </li>
    <li>
      <a href="https://github.com/GoogleCloudPlatform/google-cloud-ruby/issues" title="Google Cloud issues on Github">
        <img src="/google-cloud-ruby/img/icon-link-github.svg" alt="GitHub icon"> Issues
      </a>
    </li>
    <li>
      <a href="http://stackoverflow.com/questions/tagged/google-cloud-ruby" title="Google Cloud on StackOverflow">
      <img src="/google-cloud-ruby/img/icon-link-stackoverflow.svg" alt="StackOverflow icon"> StackOverflow
    </a>
    </li>
    <li>
      <a href="http://rubygems.org/gems/google-cloud" title="Google Cloud on RubyGems">
        <img src="/google-cloud-ruby/img/icon-link-package-manager.svg" alt="RubyGems icon"> RubyGems
      </a>
    </li>
  </ul>

  <p>
    Documentation generated by <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool">yard</a>.
  </p>
</div>

</div>
